{
  "id": "file-05",
  "title": "Context Managers",
  "category": "File Handling",
  "number": 77,
  "duration": "7 min read",
  "content": "## Context Managers for File Handling\n\nContext managers provide a clean, safe way to handle files. The `with` statement ensures files are properly closed, even if exceptions occur.\n\n## The with Statement\n\n```python\n# Using context manager (recommended)\nwith open('file.txt', 'r') as file:\n    content = file.read()\n# File is automatically closed here\n\n# Equivalent manual approach\nfile = open('file.txt', 'r')\ntry:\n    content = file.read()\nfinally:\n    file.close()\n```\n\n## Why Use Context Managers?\n\n### 1. Automatic Cleanup\n\n```python\n# File is closed even if error occurs\nwith open('data.txt', 'r') as file:\n    content = file.read()\n    process(content)  # Even if this fails...\n# ...file is still closed properly\n```\n\n### 2. Cleaner Code\n\n```python\n# No need for try/finally\n# No need to remember file.close()\nwith open('data.txt', 'w') as file:\n    file.write('Hello, World!')\n```\n\n### 3. Exception Safety\n\n```python\ntry:\n    with open('data.txt', 'r') as file:\n        # If anything here raises an exception\n        data = int(file.read())\nexcept ValueError:\n    print('Invalid data in file')\n# File is closed regardless of exception\n```\n\n## Working with Multiple Files\n\n```python\n# Multiple files in one with statement\nwith open('input.txt', 'r') as infile, open('output.txt', 'w') as outfile:\n    content = infile.read()\n    outfile.write(content.upper())\n\n# Alternative formatting for readability\nwith (\n    open('source.txt', 'r') as source,\n    open('dest.txt', 'w') as dest,\n    open('log.txt', 'a') as log\n):\n    data = source.read()\n    dest.write(data)\n    log.write('Copy complete\\n')\n```\n\n## Nested Context Managers\n\n```python\nwith open('main.txt', 'w') as main:\n    main.write('Header\\n')\n    \n    with open('data.txt', 'r') as data:\n        main.write(data.read())\n    \n    main.write('\\nFooter')\n```\n\n## The File Object in Context\n\n```python\nwith open('example.txt', 'r') as f:\n    # All file methods available\n    print(f.name)         # Filename\n    print(f.mode)         # Mode\n    print(f.closed)       # False (still open)\n    \n    # Read operations\n    line = f.readline()\n    remaining = f.read()\n\nprint(f.closed)  # True (now closed)\n```\n\n## Practical Examples\n\n### Copy File with Progress\n\n```python\nimport os\n\ndef copy_file(source, dest):\n    with open(source, 'rb') as src, open(dest, 'wb') as dst:\n        total = os.path.getsize(source)\n        copied = 0\n        \n        while True:\n            chunk = src.read(8192)\n            if not chunk:\n                break\n            dst.write(chunk)\n            copied += len(chunk)\n            print(f'Progress: {copied}/{total} bytes')\n```\n\n### Process and Transform File\n\n```python\ndef process_csv(input_file, output_file):\n    with open(input_file, 'r') as inp, open(output_file, 'w') as out:\n        # Skip header\n        header = inp.readline()\n        out.write(header.upper())\n        \n        # Process each line\n        for line in inp:\n            fields = line.strip().split(',')\n            # Transform and write\n            out.write(','.join(f.strip() for f in fields) + '\\n')\n```\n\n### Atomic File Write\n\n```python\nimport os\n\ndef safe_write(filename, content):\n    \"\"\"Write to temp file, then rename (atomic operation)\"\"\"\n    temp_file = filename + '.tmp'\n    \n    with open(temp_file, 'w') as f:\n        f.write(content)\n    \n    os.replace(temp_file, filename)  # Atomic on most systems\n```\n\n### Log File Handler\n\n```python\nfrom datetime import datetime\n\nclass Logger:\n    def __init__(self, filename):\n        self.filename = filename\n    \n    def log(self, message):\n        with open(self.filename, 'a') as f:\n            timestamp = datetime.now().isoformat()\n            f.write(f'[{timestamp}] {message}\\n')\n\n# Usage\nlogger = Logger('app.log')\nlogger.log('Application started')\nlogger.log('User logged in')\n```\n\n## Creating Custom Context Managers\n\n```python\nfrom contextlib import contextmanager\n\n@contextmanager\ndef open_file(name, mode):\n    \"\"\"Custom file context manager with logging\"\"\"\n    print(f'Opening {name}')\n    f = open(name, mode)\n    try:\n        yield f\n    finally:\n        f.close()\n        print(f'Closed {name}')\n\n# Usage\nwith open_file('data.txt', 'w') as f:\n    f.write('Hello!')\n```\n\n## Best Practices\n\n```python\n# DO: Use context managers\nwith open('file.txt', 'r') as f:\n    data = f.read()\n\n# DON'T: Manual open/close\nf = open('file.txt', 'r')\ndata = f.read()\nf.close()  # Might not run if error occurs\n\n# DO: Handle exceptions around with\ntry:\n    with open('file.txt', 'r') as f:\n        data = f.read()\nexcept FileNotFoundError:\n    data = 'default value'\n```",
  "code": "# Context Managers for File Handling\nimport os\n\n# Example 1: Basic context manager\nprint(\"=== Basic Context Manager ===\")\nwith open('example.txt', 'w') as f:\n    f.write('Hello from context manager!\\n')\n    f.write('This is safe and clean.')\n    print(f\"Inside 'with': file closed? {f.closed}\")\n\nprint(f\"Outside 'with': file closed? {f.closed}\")\n\n# Verify content\nwith open('example.txt', 'r') as f:\n    print(f\"Content: {f.read()}\")\n\n# Example 2: Multiple files\nprint(\"\\n=== Multiple Files ===\")\nwith open('source.txt', 'w') as f:\n    f.write('Source content here')\n\nwith open('source.txt', 'r') as src, open('dest.txt', 'w') as dst:\n    content = src.read()\n    dst.write(f\"Copied: {content}\")\n    print(f\"Copied from {src.name} to {dst.name}\")\n\nwith open('dest.txt', 'r') as f:\n    print(f\"Destination content: {f.read()}\")\n\n# Example 3: Exception safety\nprint(\"\\n=== Exception Safety ===\")\ntry:\n    with open('numbers.txt', 'w') as f:\n        f.write('not a number')\n    \n    with open('numbers.txt', 'r') as f:\n        value = int(f.read())  # This will raise ValueError\nexcept ValueError:\n    print(\"Caught ValueError - but file is still closed!\")\n\nprint(f\"File closed after exception? {f.closed}\")\n\n# Example 4: Nested context managers\nprint(\"\\n=== Nested Context Managers ===\")\nwith open('report.txt', 'w') as report:\n    report.write('=== REPORT ===\\n\\n')\n    \n    with open('source.txt', 'r') as data:\n        report.write('Data: ' + data.read() + '\\n')\n    \n    report.write('\\n=== END ===')\n\nwith open('report.txt', 'r') as f:\n    print(f.read())\n\n# Example 5: File transformation\nprint(\"\\n=== File Transformation ===\")\nwith open('original.txt', 'w') as f:\n    f.write('hello world\\npython is great\\nfile handling rocks')\n\nwith open('original.txt', 'r') as inp, open('upper.txt', 'w') as out:\n    for line in inp:\n        out.write(line.upper())\n\nwith open('upper.txt', 'r') as f:\n    print(f.read())\n\n# Example 6: Custom context manager\nprint(\"\\n=== Custom Context Manager ===\")\nfrom contextlib import contextmanager\n\n@contextmanager\ndef tracked_file(name, mode):\n    print(f\"[OPEN] {name}\")\n    f = open(name, mode)\n    try:\n        yield f\n    finally:\n        f.close()\n        print(f\"[CLOSE] {name}\")\n\nwith tracked_file('tracked.txt', 'w') as f:\n    f.write('Tracked write operation')\n\n# Clean up\nprint(\"\\n=== Cleanup ===\")\nfor fname in ['example.txt', 'source.txt', 'dest.txt', 'numbers.txt', \n              'report.txt', 'original.txt', 'upper.txt', 'tracked.txt']:\n    if os.path.exists(fname):\n        os.remove(fname)\nprint(\"All temporary files cleaned up.\")"
}
